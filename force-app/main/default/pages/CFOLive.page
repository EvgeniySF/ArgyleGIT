<apex:page controller="RegistrationPageController" showHeader="false">   
    <apex:stylesheet value="{!URLFOR($Resource.CFORegistrationStyles, 'RegistrationPageStyles.css')}"/>
    <html>
         <head>
            
        </head>
   
    
    <body>
    <input type="hidden" name="currentvfpage" value="{!$CurrentPage.Name}"/>

        <div id="headerMain">
            <div id="header" >
                 
                    <table>
                        <tr>
                            <td style="padding-left: 40px;">
                                <a href="https://argyleforum.com">
                        <img src="https://dlpbmt6cqrdgu.cloudfront.net/wp-content/uploads/2020/02/cfo-live-logo.png" alt="CFO Live Virtual 2020 November" style="max-width: 15rem; margin-top: 1.5rem;"/> 
                    </a>
                            </td>
                            <td style="padding-left: 20px; vertical-align:bottom;text-align:center;">
                                <span style="font-size: 1.2rem; color: white; font-weight: bold; text-transform: uppercase;">November 04 - 05, 2020</span>
                            </td>
                        </tr>
                    </table>
                     
             </div>
        </div>
    <div class="wrapperCard">
        <div class="cards_wrap">    
            <div class="card_item">
                <div class="card_inner2"> 
                    <div class="card_bottom2" style="position: relative; overflow: hidden;"><!-- overflow: hidden;-->
                        <div class="card_category">
                            All Access Pass
                        </div>
                        <div class="card_info"> 
                            <p>
                                Don't miss a minute. The best value pass gives you access to absolutely everything at the event.
                            </p>
                            <p class="title" style="margin-top: 20px;"><span style="text-decoration: line-through; text-decoration-color: red;">{!IF(NOT(ISBLANK($Setup.Stripe_Integration__c.All_Access_Cost_Crossed_Out__c)), '$', '')}{!IF(NOT(ISBLANK($Setup.Stripe_Integration__c.All_Access_Cost_Crossed_Out__c)), $Setup.Stripe_Integration__c.All_Access_Cost_Crossed_Out__c , '')}</span>&nbsp;${!$Setup.Stripe_Integration__c.All_Access_Pass_Cost__c}</p>
                        </div>
                        <div class="card_creator" onclick="setTimeout(function(){window.location='#form';}, 500); test('allDay', 'All Access Pass', 'card_bottom2');" style=" position: relative; z-index: 10; cursor: pointer; margin: 0 auto; text-align: center; border: none; color: black; padding-top: 7px; font-size: 14px; font-weight: bold; background:  white;"> 
                            Register Now
                        </div> 
                        <div style="margin-top: 10px; color: white; font-size: 16px; text-align: center; position: relative; z-index: 10;"> 
                       <!-- Expires Friday, October 23rd! -->
                        </div>
                      <!-- <div class="triangle" style="bottom: -18%; right: -22%; width:50%; background: #474747; height: 40%; position: absolute; -webkit-transform: rotate(45deg);">
                            text
                        </div> -->
                        <div class="triangle">
                            
                        </div>
                          <div class="limitedTime" >
                            LIMITED
                              <br/>
                              TIME
                        </div>
                    </div>
                </div>
            </div>
            <div class="card_item" >
                <div class="card_inner1">  
                    <div class="card_bottom1">
                        <div class="card_category">
                            LIMITED PASS
                        </div>
                        <div class="card_info">
                            
                            <p>
                                Gain access to our exhibit hall, keynote sessions, and sponsored sessions.
                            </p>
                            <p class="title" style="margin-top: 20px;">${!$Setup.Stripe_Integration__c.Limited_Pass__c}</p>
                        </div>
                        <div class="card_creator" onclick="setTimeout(function(){window.location='#form';}, 500); test('limited', 'Limited Pass', 'card_bottom1');" style="cursor: pointer; margin: 0 auto; text-align: center; border: none; color: white; padding-top: 7px; font-size: 14px; font-weight: bold; background: rgb(34, 136, 205);"> 
                            Register Now
                        </div>
                    </div>
                </div>
            </div> 
            
          <!--  <div class="card_item">
                <div class="card_inner3"> 
                    <div class="card_bottom3">
                        <div class="card_category">
                            1 Day Pass
                        </div>
                        <div class="card_info"> 
                            <p>
                                Choose the day that suits your schedule and gain full access to everything scheduled that day.
                            </p> 
                            <p class="title" style="margin-top: 20px;"><span style="text-decoration: line-through; text-decoration-color: red;">{!IF(NOT(ISBLANK($Setup.Stripe_Integration__c.X1_Day_Pass_Cost_Crossed_Out__c)), '$', '')}{!IF(NOT(ISBLANK($Setup.Stripe_Integration__c.X1_Day_Pass_Cost_Crossed_Out__c)), $Setup.Stripe_Integration__c.X1_Day_Pass_Cost_Crossed_Out__c , '')}</span>&nbsp;${!$Setup.Stripe_Integration__c.X1_Day_Pass_Cost__c}</p>
                        </div>
                        
                        <div class="card_creator" onclick="setTimeout(function(){window.location='#form';}, 500); test('1day', '1 Day Pass', 'card_bottom3');" style="cursor: pointer; margin: 0 auto; text-align: center; border: none; color: white; padding-top: 7px; font-size: 14px; font-weight: bold; background: rgb(35,5,50); background: linear-gradient(171deg, rgba(35,5,50,1) 0%, rgba(92,28,124,1) 49%, rgba(149,74,194,1) 100%);"> 
                            Register Now
                        </div>
                    </div>
                </div>
            </div> -->
        </div>
    </div>
    
    

    <div class="wrapper" id="form" style="display: none;">
        <div class="title" style="color: grey;">
            Registration Form
        </div> 
        <div id="emptyFieldError" class="validationErrors"> </div>
        <apex:pageMessages ></apex:pageMessages>
        <div class="form" id="registrationForm">
            <div class="inputfield">
                <label>First Name*</label>
                <input id="fName" type="text" class="input"/>
            </div>  
            <div class="inputfield">
                <label>Last Name*</label>
                <input  id="lName" type="text" class="input"/>
            </div>  
            <div id="emailError" class="validationErrors"> </div>
            <div class="inputfield">
                <label>Email Address*</label>
                <input id="email" type="text" class="input"/>
            </div>
            <div class="inputfield">
                <label>Job Title*</label>
                <input id="jobTitle" type="text" class="input"/>
            </div> 
            <div class="inputfield">
                <label>Company*</label>
                <input id="company" type="text" class="input"/>
            </div> 
            <div class="inputfield">
                <label>Phone</label>
                <input type="tel" id="phone" name="phone" class="input"/> 
            </div> 
             <div class="inputfield">
                <label>Coupon Code</label>
                <input type="text" id="coupon" name="coupon" class="input"/>  
            </div>  
            <div class="inputfield">
                <label>Ticket Type*</label>
                <div class="custom_select">
                    <select id="ticketType" onChange="selectCard(this.selectedIndex);">
                        <option value="">Select</option>
                        <option value="allDay">All Access Pass</option>
                      <!--  <option value="1day">1 Day Pass</option> -->
                        <option value="limited">Limited Pass</option> 
                    </select>
                </div> 
            </div>  
            <div class="inputfield">
                <input type="submit" value="Register" id="register" class="btn" onclick="processToCheckout();"/> 
                <div id="loader" class="lds-ring" style="display: none; margin: 0 auto;"><div></div><div></div><div></div><div></div></div>
            </div>
        </div>
    </div>
        
        
         
        </body>
    </html>
    
    
    <script src="https://js.stripe.com/v3/"></script>  
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script> 
    
    <script> 
    var stripe = Stripe('{!API_KEY}'); 
    
    const $emptyError = $("#emptyFieldError");
    
    
    
    function selectCard(selectIndex){ 
        
        switch (selectIndex) {
            case 1:
                $(".card_bottom1").removeClass("selected");
                $(".card_bottom2").addClass("selected");
                $(".card_bottom3").removeClass("selected");
                break;
            case 2:
                $(".card_bottom1").removeClass("selected");
                $(".card_bottom2").removeClass("selected");
                $(".card_bottom3").addClass("selected");
                break;
            case 3:
                $(".card_bottom1").addClass("selected");
                $(".card_bottom2").removeClass("selected");
                $(".card_bottom3").removeClass("selected");
                break;
            default:
                $(".card_bottom1").removeClass("selected");
                $(".card_bottom2").removeClass("selected");
                $(".card_bottom3").removeClass("selected");
        }
        
        
    }
    
    
    
    function test(selector, value, cardSelector){     
        $("#form").show(500);
        $("select option[value=" + selector + "]").prop('selected', 'true').text(value);
        $("." + cardSelector + "").addClass("selected");
        
        switch (cardSelector) {
            case 'card_bottom1':
                $(".card_bottom2").removeClass("selected");
                $(".card_bottom3").removeClass("selected");             
                break;
            case 'card_bottom2':
                $(".card_bottom1").removeClass("selected");
                $(".card_bottom3").removeClass("selected");  
                break;
            case 'card_bottom3':
                $(".card_bottom1").removeClass("selected");
                $(".card_bottom2").removeClass("selected"); 
                break;
            default:
                alert( "" );
        }
    }
    
    function processToCheckout() { 
        var ticketTypeConfirm = document.getElementById("ticketType").value;  
        if(validate()){
            let isConfirmed = confirm("You have selected the " + $("select option[value=" + ticketTypeConfirm + "]").text() + " ticket.\n Please click 'OK' to proceed with Checkout or 'Cancel' to select another ticket type.");
            if(isConfirmed){
                $("#loader").show(100);
                $("#register").hide();
                var fname = document.getElementById("fName").value;
                var lname = document.getElementById("lName").value;
                var email = document.getElementById("email").value;
                var jobTitle = document.getElementById("jobTitle").value;
                var company = document.getElementById("company").value;
                var phone = document.getElementById("phone").value;  
                var ticketType = document.getElementById("ticketType").value;  
                var coupon = document.getElementById("coupon").value;
                var ticketAccessType = $("select option[value=" + ticketType + "]").text();        
                
                
                Visualforce.remoting.Manager.invokeAction(
                    "{!$RemoteAction.RegistrationPageController.checkIsNotBlankAndCoupon}",  
                    ticketType, coupon, 'CFOLive',
                    function(result, event){
                        if (event.status) { 
                            console.log(result);
                              if(!result.isNotBlank && !result.hasCoupon){  
                                console.log('ticketType = ' + result.coupon); //вернуть json {'true', coupone codes}
                                console.log('ticketAccessType = ' + result.isNotBlank);
                                  stripeCallout(fname, lname, email, jobTitle, company, phone, ticketType, ticketAccessType, 'CFOLive');
                            }
                            else{  
                                insertEventParticipant(fname, lname, email, jobTitle, company, phone, ticketType, ticketAccessType, 'CFOLive');
                            }
                        } else if (event.type === 'exception') {  
                            $emptyError.text("Registration failed. Please refresh the page and register again.");
                            $emptyError.css("margin-left", "22%");
                            
                            $("#loader").hide();
                            $("#register").show();
                        } else {   
                        } 
                    }, 
                    {escape: true}
                ); 
            }
        }
    }
    
    function stripeCallout(fname, lname, email, jobTitle, company, phone, ticketType, ticketAccessType, eventName){
        Visualforce.remoting.Manager.invokeAction(
            "{!$RemoteAction.RegistrationPageController.startRequest}", 
            fname, lname, email, jobTitle, company, phone, ticketType, ticketAccessType, eventName,
            function(result, event){
                if (event.status) { 
                    redirect(result);
                    
                } else if (event.type === 'exception') {   
                    $emptyError.text("Registration failed. Please refresh the page and register again.");
                    $emptyError.css("margin-left", "22%"); 
                    $("#loader").hide();
                    $("#register").show();
                } else {   
                }
            }, 
            {escape: true}
        ); 
    }
    
    function insertEventParticipant(fname, lname, email, jobTitle, company, phone, ticketType, ticketAccessType, eventName){
        Visualforce.remoting.Manager.invokeAction(
            "{!$RemoteAction.RegistrationPageController.insertEventParticipant}", 
            fname, lname, email, jobTitle, company, phone, ticketType, ticketAccessType, eventName,
            function(result, event){
                if (event.status) { 
                    window.location.replace(result);
                } else if (event.type === 'exception') {  
                    $emptyError.text("Registration failed. Please refresh the page and register again.");
                    $emptyError.css("margin-left", "22%");
                    $("#loader").hide();
                    $("#register").show();
                } else {   
                }
            }, 
            {escape: true}
        ); 
    }
    
    function redirect(id){ 
        stripe.redirectToCheckout({ 
            sessionId: id 
        }).then(function (result) { 
            
        });
    }
    
    document.getElementById("phone").addEventListener("keypress", function (evt) {
        if (evt.which < 48 || evt.which > 57)
        {
            evt.preventDefault();
        }
    });
    
    
    
    function validateEmail(email) {
        const re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return re.test(email);
    }
    
    
    function validate() {
        
        var allFieldsFIlledIn = true;
        
        const $emptyError = $("#emptyFieldError");
        
        
        $('#registrationForm select').filter (function()
                                              {
                                                  if( this.value === 'Select' ) {
                                                      $(this).css("border", "1px solid red"); 
                                                      if($(this)[0].id === 'ticketType'){
                                                          $emptyError.text("Select the Ticket Type");
                                                          $emptyError.css("margin-left", "22%");
                                                      }
                                                      else{
                                                          $emptyError.text("Select the Annual Revenue");
                                                          $emptyError.css("margin-left", "22%");
                                                      }
                                                      allFieldsFIlledIn = false;
                                                  } else {
                                                      $(this).css("border", "1px solid #d5dbd9");
                                                  }
                                              });
        
        $('#registrationForm input').filter (function()
                                             { 
                                                 if( !this.value && $(this)[0].id !== 'phone') {
                                                     $(this).css("border", "1px solid red");
                                                     $emptyError.text("Fill in all the required fields");
                                                     $emptyError.css("margin-left", "22%");
                                                     allFieldsFIlledIn = false;
                                                 } else {
                                                     if($(this)[0].id === 'email' && $(this)[0].value.length !== 0)
                                                     { 
                                                         const $result = $("#emailError");
                                                         const $emailfield = $("#email");
                                                         const email = $("#email").val();
                                                         $result.text("");
                                                         
                                                         if (validateEmail(email)) { 
                                                             $emailfield.css("border", "1px solid #d5dbd9");
                                                         } else {
                                                             $result.text("Email Address is invalid");
                                                             $result.css("margin-left", "22%");
                                                             $emailfield.css("border", "1px solid red"); 
                                                         }
                                                     }
                                                     else{
                                                         $(this).css("border", "1px solid #d5dbd9");
                                                     }
                                                     
                                                     
                                                     
                                                 }
                                             });
        
        
        return allFieldsFIlledIn;
    }
    
    $("#register").on("click", validate); 
    
    
    $('#registrationForm select').blur (function()
                                        {
                                            if( this.value === 'Select' ) {
                                                $(this).css("border", "1px solid red"); 
                                                if($(this)[0].id === 'ticketType'){
                                                    $emptyError.text("Select the Ticket Type");
                                                    $emptyError.css("margin-left", "22%");
                                                }
                                                else{
                                                    $emptyError.text("Select the Annual Revenue");
                                                    $emptyError.css("margin-left", "22%");
                                                }
                                                
                                            } else {
                                                $(this).css("border", "1px solid #d5dbd9");
                                            }
                                        });
    
    
    $('#registrationForm input').blur (function()
                                       { 
                                           if( !this.value  && $(this)[0].id !== 'phone') {
                                               $(this).css("border", "1px solid red");
                                               $emptyError.text("Fill in all the required fields");
                                               $emptyError.css("margin-left", "22%");
                                           } else {
                                               if($(this)[0].id === 'email' && $(this)[0].value.length !== 0)
                                               {
                                                   
                                                   const $result = $("#emailError");
                                                   const $emailfield = $("#email");
                                                   const email = $("#email").val();
                                                   $result.text("");
                                                   
                                                   if (validateEmail(email)) {
                                                       
                                                       $emailfield.css("border", "1px solid #d5dbd9");
                                                   } else {
                                                       $result.text("Email Address is invalid");
                                                       $result.css("margin-left", "22%");
                                                       $emailfield.css("border", "1px solid red"); 
                                                   }
                                               }
                                               else{
                                                   $(this).css("border", "1px solid #d5dbd9");
                                                   $emptyError.text("");
                                               }
                                               
                                               
                                               
                                           }
                                       });
    
    
    </script>
</apex:page>